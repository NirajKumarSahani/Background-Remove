<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Background Remover & Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        #container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 550px;
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 1.5rem;
        }
        .button {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: background-color 0.3s ease;
            margin: 0.25rem;
            border: none;
            font-size: 1rem;
        }
        #upload-label { background-color: #007bff; }
        #upload-label:hover { background-color: #0056b3; }
        #download-btn { background-color: #28a745; display: none; }
        #download-btn:hover { background-color: #218838; }
        #reset-btn { background-color: #dc3545; display: none; }
        #reset-btn:hover { background-color: #c82333; }
        #image-input { display: none; }
        #result-container {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }
        #result-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 6px;
            display: block; 
        }
        #status-text { color: #555; font-weight: 500; }
        small { margin-top: 1rem; display: block; color: #888; }
        .controls-group {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
            width: 100%;
        }
        .edit-section {
            width: 100%;
            padding: 15px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
        }
        .edit-section h3 { margin-top: 0; margin-bottom: 15px; color: #555;}
        .controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
        }
        .controls-row input[type="text"] {
             width: 60%;
             padding: 8px;
             border: 1px solid #ccc;
             border-radius: 4px;
        }
        #crop-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        #crop-modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
        }
        #crop-image-container { max-height: 60vh; }
        #crop-image-container img { max-width: 100%; }
        #crop-actions { margin-top: 15px; text-align: right; }
        #confirm-crop-btn { background-color: #28a745; }
        #cancel-crop-btn { background-color: #6c757d; }
        #pexels-results { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; max-height: 180px; overflow-y: auto; margin-top: 10px;}
        .pexels-thumbnail { width: 75px; height: 75px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .pexels-thumbnail.selected { border-color: #007bff; }
    </style>
</head>
<body>

    <div id="container">
        <h1>üñº AI Background Remover & Editor</h1>
        <p>Upload an image to automatically remove its background.</p>
        <input type="file" id="image-input" accept="image/png, image/jpeg, image/webp">
        <div>
            <label for="image-input" id="upload-label" class="button">Choose Image</label>
            <a href="#" id="download-btn" class="button" download="background-removed.png" target="_blank" rel="noopener noreferrer">‚¨á Download</a>
            <a href="#" id="reset-btn" class="button">‚Ü∫ Reset</a>
        </div>
        <div id="edit-controls" class="controls-group">
            <div class="edit-section">
                <h3>Basic Edits</h3>
                <div class="controls-row">
                    <button id="open-crop-tool-btn" class="button" style="background-color: #fd7e14;">‚úÇÔ∏è Crop Image</button>
                </div>
            </div>
            <div class="edit-section">
                <h3>Add Solid Background</h3>
                <div class="controls-row">
                    <input type="color" id="color-picker" value="#ffffff" title="Choose background color">
                    <button id="apply-color-btn" class="button" style="background-color: #6f42c1;">Apply Color</button>
                </div>
            </div>
            <div class="edit-section">
                <h3>‚ú® Add Magic Background (Pexels)</h3>
                <div class="controls-row">
                    <input type="text" id="pexels-search-input" placeholder="e.g., nature, city" title="Search Pexels">
                    <button id="pexels-search-btn" class="button" style="background-color: #008cba;">Search</button>
                </div>
                <div id="pexels-status"></div>
                <div id="pexels-results"></div>
                <button id="apply-pexels-btn" class="button" style="background-color: blue;">Apply Background</button>
            </div>
        </div>
        <div id="result-container">
            <img id="result-image" src="" alt="Your edited image will appear here">
            <p id="status-text">Result will appear here...</p>
        </div>
        <small>Powered by remove.bg API & Pexels</small>
    </div>

    <div id="crop-modal">
        <div id="crop-modal-content">
            <h2>Crop Image</h2>
            <div id="crop-image-container"><img id="image-to-crop" src=""></div>
            <div id="crop-actions">
                <button id="cancel-crop-btn" class="button">Cancel</button>
                <button id="confirm-crop-btn" class="button">Confirm Crop</button>
            </div>
        </div>
    </div>

    <script>
        // Element References
        const imageInput = document.getElementById('image-input');
        const resultImage = document.getElementById('result-image');
        const statusText = document.getElementById('status-text');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtn = document.getElementById('reset-btn');
        const editControls = document.getElementById('edit-controls');
        const colorPicker = document.getElementById('color-picker');
        const applyColorBtn = document.getElementById('apply-color-btn');
        const pexelsSearchInput = document.getElementById('pexels-search-input');
        const pexelsSearchBtn = document.getElementById('pexels-search-btn');
        const pexelsStatus = document.getElementById('pexels-status');
        const pexelsResults = document.getElementById('pexels-results');
        const applyPexelsBtn = document.getElementById('apply-pexels-btn');
        const openCropToolBtn = document.getElementById('open-crop-tool-btn');
        const cropModal = document.getElementById('crop-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const confirmCropBtn = document.getElementById('confirm-crop-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');

        // API Keys
        const removeBgApiKey = 'ZC979Wh5Gg46qpZ7FePZhF4f';
        const pexelsApiKey = 'wvma6eM51xVJAw4mCkhXQVf6idufFOSFtGZkVhMpfGTxUTCl1aOGTiqJ'; // Your Pexels Key is now here

        // State Variables
        let originalTransparentUrl = null;
        let currentImageUrl = null;
        let selectedPexelsImageUrl = null;
        let foregroundImage = null;
        let cropper = null;

        function handleError(errorMessage) {
            console.error(errorMessage);
            statusText.textContent = `Error: ${errorMessage}`;
            statusText.style.display = 'block';
            resultImage.style.display = 'none';
            downloadBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            editControls.style.display = 'none';
        }

        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            statusText.textContent = 'Preparing to upload...';
            statusText.style.display = 'block';
            resultImage.style.display = 'none';
            downloadBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            editControls.style.display = 'none';
            if (originalTransparentUrl) URL.revokeObjectURL(originalTransparentUrl);
            originalTransparentUrl = null;

            const formData = new FormData();
            formData.append('image_file', file);
            formData.append('size', 'preview');

            try {
                const blob = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'https://api.remove.bg/v1.0/removebg', true);
                    xhr.setRequestHeader('X-Api-Key', removeBgApiKey);
                    xhr.responseType = 'blob';
                    xhr.upload.onprogress = e => {
                        if (e.lengthComputable) statusText.textContent = `Uploading: ${Math.round((e.loaded / e.total) * 100)}%`;
                    };
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            resolve(xhr.response);
                        } else {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                try {
                                    const err = JSON.parse(reader.result);
                                    reject(err.errors[0].title);
                                } catch(e) { reject(`API Error ${xhr.status}`) }
                            };
                            reader.readAsText(xhr.response);
                        }
                    };
                    xhr.onerror = () => reject('Network Error');
                    xhr.send(formData);
                });

                originalTransparentUrl = URL.createObjectURL(blob);
                foregroundImage = new Image();
                foregroundImage.crossOrigin = 'anonymous';
                await new Promise(resolve => {
                    foregroundImage.onload = resolve;
                    foregroundImage.src = originalTransparentUrl;
                });
                
                resetToOriginal();
            } catch (error) {
                handleError(error.toString());
            }
        });

        function resetToOriginal() {
            if (!originalTransparentUrl || !foregroundImage) return;
            resultImage.src = originalTransparentUrl;
            currentImageUrl = originalTransparentUrl;
            downloadBtn.href = originalTransparentUrl;
            selectedPexelsImageUrl = null;
            colorPicker.value = '#ffffff';
            pexelsResults.innerHTML = '';
            pexelsStatus.textContent = '';
            applyPexelsBtn.style.display = 'none';
            statusText.style.display = 'none';
            resultImage.style.display = 'block';
            downloadBtn.style.display = 'inline-block';
            resetBtn.style.display = 'inline-block';
            editControls.style.display = 'flex';
        }
        resetBtn.addEventListener('click', resetToOriginal);

        function renderImageWithBackground(backgroundSource, isPexels = false) {
            if (!foregroundImage) return;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = foregroundImage.naturalWidth;
            canvas.height = foregroundImage.naturalHeight;
            
            const finalize = () => {
                ctx.drawImage(foregroundImage, 0, 0);
                const dataUrl = canvas.toDataURL('image/png');
                resultImage.src = dataUrl;
                currentImageUrl = dataUrl;
                downloadBtn.href = dataUrl;
            };

            if (isPexels) {
                const bgImg = new Image();
                bgImg.crossOrigin = "anonymous";
                bgImg.onload = () => {
                    const canvasRatio = canvas.width / canvas.height;
                    const bgRatio = bgImg.width / bgImg.height;
                    let sx=0, sy=0, sWidth=bgImg.width, sHeight=bgImg.height;
                    if (bgRatio > canvasRatio) {
                        sWidth = bgImg.height * canvasRatio;
                        sx = (bgImg.width - sWidth) / 2;
                    } else {
                        sHeight = bgImg.width / canvasRatio;
                        sy = (bgImg.height - sHeight) / 2;
                    }
                    ctx.drawImage(bgImg, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
                    finalize();
                };
                bgImg.src = backgroundSource;
            } else {
                ctx.fillStyle = backgroundSource;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                finalize();
            }
        }
        
        applyColorBtn.addEventListener('click', () => {
            renderImageWithBackground(colorPicker.value, false);
        });

        pexelsSearchBtn.addEventListener('click', async () => {
            const query = pexelsSearchInput.value.trim();
            if (!query) { pexelsStatus.textContent = 'Please enter a search term.'; return; }
            if (!pexelsApiKey || pexelsApiKey === 'YOUR_Pexels_API_Key_Here') { pexelsStatus.textContent = 'Pexels API Key is missing.'; return; }
            
            pexelsStatus.textContent = 'Searching...';
            try {
                const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=15`, {
                    headers: { Authorization: pexelsApiKey }
                });
                if (!response.ok) throw new Error(`API returned status ${response.status}`);
                const data = await response.json();
                pexelsResults.innerHTML = '';
                if (data.photos.length === 0) { pexelsStatus.textContent = 'No results found.'; return; }
                pexelsStatus.textContent = 'Select a background:';
                data.photos.forEach(photo => {
                    const img = document.createElement('img');
                    img.src = photo.src.tiny;
                    img.dataset.fullUrl = photo.src.large2x;
                    img.className = 'pexels-thumbnail';
                    img.onclick = () => {
                        document.querySelectorAll('.pexels-thumbnail').forEach(t => t.classList.remove('selected'));
                        img.classList.add('selected');
                        selectedPexelsImageUrl = img.dataset.fullUrl;
                        applyPexelsBtn.style.display = 'inline-block';
                    };
                    pexelsResults.appendChild(img);
                });
            } catch (error) {
                pexelsStatus.textContent = `Search failed: ${error.message}`;
            }
        });
        
        applyPexelsBtn.addEventListener('click', () => {
            if (selectedPexelsImageUrl) {
                renderImageWithBackground(selectedPexelsImageUrl, true);
            }
        });

        openCropToolBtn.addEventListener('click', () => {
            if (!currentImageUrl) return;
            imageToCrop.src = currentImageUrl;
            cropModal.style.display = 'flex';
            if (cropper) cropper.destroy();
            cropper = new Cropper(imageToCrop, { viewMode: 1, background: false, autoCropArea: 0.8 });
        });

        cancelCropBtn.addEventListener('click', () => {
            if (cropper) cropper.destroy();
            cropModal.style.display = 'none';
        });

        confirmCropBtn.addEventListener('click', () => {
            if (!cropper) return;
            const dataUrl = cropper.getCroppedCanvas({ imageSmoothingQuality: 'high' }).toDataURL('image/png');
            resultImage.src = dataUrl;
            currentImageUrl = dataUrl;
            downloadBtn.href = dataUrl;
            if (cropper) cropper.destroy();
            cropModal.style.display = 'none';
        });
    </script>
</body>
</html>